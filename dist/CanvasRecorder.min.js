/*!
 * @tawaship/canvas-recorder - v1.0.0
 * 
 * @author tawaship (makazu.mori@gmail.com)
 * @license MIT
 */
var CanvasRecorder=function(){"use strict";
/*!
 * @tawaship/emitter - v3.0.0
 * 
 * @author tawaship (makazu.mori@gmail.com)
 * @license MIT
 */var e,t,r=function(){this._events={}},o={eventNames:{configurable:!0}};o.eventNames.get=function(){return Object.keys(this._events)},r.prototype._on=function(e,t,r){if(!e||!t)return this;for(var o=this._events[e]=this._events[e]||[],n=0;n<o.length;n++)if(o[n].func===t)return this;return o.push({func:t,once:r}),this},r.prototype.on=function(e,t){return this._on(e,t,!1)},r.prototype.once=function(e,t){return this._on(e,t,!0)},r.prototype.off=function(e,t){if(!e||!t)return this;for(var r=this._events[e]||[],o=0;o<r.length;o++)if(r[o].func===t)return r.splice(o,1),this;return this},r.prototype.emit=function(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];if(!e)return this;for(var o=this._events[e]||[],n=[],i=o.length-1;i>=0;i--){var s=o[i];s.once&&o.splice(i,1),n.push(s)}for(var a=n.length-1;a>=0;a--)n[a].func.apply(this,t);return this},r.prototype.cemit=function(e,t){for(var r=[],o=arguments.length-2;o-- >0;)r[o]=arguments[o+2];if(!e||null==t)return this;for(var n=this._events[e]||[],i=[],s=n.length-1;s>=0;s--){var a=n[s];a.once&&n.splice(s,1),i.push(a)}for(var c=i.length-1;c>=0;c--)i[c].func.apply(t,r);return this},r.prototype.clear=function(e){return void 0===e&&(e=""),e?delete this._events[e]:this._events={},this},Object.defineProperties(r.prototype,o);var n={channelCount:2},i=function(e){this._blobURL=window.URL.createObjectURL(e)},s={blobURL:{configurable:!0}};i.prototype.createVideoElement=function(){if(!this._blobURL)throw new Error("[CanvasRecorder] This movie instance was destroyed.");var e=document.createElement("video");return e.src=this._blobURL,e.setAttribute("controls",""),e},i.prototype.download=function(e){if(!this._blobURL)throw new Error("[CanvasRecorder] This movie instance was destroyed.");var t=document.createElement("a");t.download=e?e+".webm":location.hostname+"_"+(new Date).toLocaleString().replace(/[\/\s\:]/g,"-")+".webm",t.href=this._blobURL,t.click()},s.blobURL.get=function(){if(!this._blobURL)throw new Error("[CanvasRecorder] This movie instance was destroyed.");return this._blobURL},i.prototype.destroy=function(){window.URL.revokeObjectURL(this._blobURL),this._blobURL=null},Object.defineProperties(i.prototype,s);var a=Symbol(),c=Symbol(),u=function(o,n){var i=this;void 0===n&&(n={}),this._buildPromise=null,this._buildEmitter=new r,this._movie=null,this[e]=null,this[t]=null;var s=[];this._recorder=new MediaRecorder(o,n),this._recorder.addEventListener("dataavailable",(function(e){s.push(e.data)})),this._recorder.addEventListener("stop",(function(e){i._buildEmitter.emit("finish",s),s=[]}))};return u.prototype.start=function(e){var t=this;"inactive"===this._recorder.state&&(this.clearMovie(),this._buildPromise=new Promise((function(e){t._buildEmitter.once("finish",(function(r){var o=new Blob(r,{type:r[0].type});t._movie=new i(o),e(t._movie)}))})),this._recorder.start(e))},u.prototype.finishAsync=function(){return"recording"!==this._recorder.state||this._recorder.stop(),this._buildPromise},u.prototype.pause=function(){"recording"===this._recorder.state&&this._recorder.pause()},u.prototype.resume=function(){"paused"===this._recorder.state&&this._recorder.resume()},u.prototype.clearMovie=function(){this._movie&&(this._movie.destroy(),this._movie=null)},u.prototype.destroy=function(){this.clearMovie(),this._recorder.stream.getTracks().forEach((function(e){return e.stop()})),this._releaseDisplayStream(),this._releaseUserStream()},u.prototype._releaseDisplayStream=function(){this[a]&&this[a].getTracks().forEach((function(e){return e.stop()}))},u.prototype._releaseUserStream=function(){this[c]&&this[c].getTracks().forEach((function(e){return e.stop()}))},u.prototype.disabled=function(e){this._recorder.stream.getTracks().forEach((function(t){return t.enabled=!e}))},u.prototype.hide=function(e){this._recorder.stream.getVideoTracks().forEach((function(t){return t.enabled=!e}))},u.prototype.mute=function(e){this._recorder.stream.getAudioTracks().forEach((function(t){return t.enabled=!e}))},u.prototype.addAudioAsync=function(e){var t=this;void 0===e&&(e={display:!0});var r=[];return Promise.resolve().then((function(){if(!e.display)return Promise.resolve();if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)return Promise.reject();t._releaseDisplayStream();var o=!0===e.display?n:e.display;return navigator.mediaDevices.getDisplayMedia({audio:o,video:!0}).then((function(e){t[a]=e,e.getVideoTracks().forEach((function(e){return e.stop()})),r.push(e)}))})).catch((function(e){console.error(e),console.warn("[CanvasRecorder] Can not use display media.")})).then((function(){if(!e.user)return Promise.resolve();if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return Promise.reject();t._releaseUserStream();var o=!0===e.user?n:e.user;return navigator.mediaDevices.getUserMedia({audio:o}).then((function(e){t[c]=e,e.getVideoTracks().forEach((function(e){return e.stop()})),r.push(e)}))})).catch((function(e){console.error(e),console.warn("[CanvasRecorder] Can not use user media.")})).then((function(){if(r.length)if(r.reduce((function(e,t){return e+t.getAudioTracks().length}),0)){if(!AudioContext)return console.warn('[CanvasRecorder] Priority is given to "display media" as multiple audio tracks cannot be used.'),void r.forEach((function(e){return e.getAudioTracks().forEach((function(e){return t._recorder.stream.addTrack(e)}))}));var e=new AudioContext,o=e.createMediaStreamDestination();r.forEach((function(t){return e.createMediaStreamSource(t).connect(o)})),t._recorder.stream.addTrack(o.stream.getAudioTracks()[0])}else console.warn("[CanvasRecorder] No audio stream.");else console.warn("[CanvasRecorder] No audio stream.")}))},u.create=function(e,t){void 0===t&&(t={});var r=new MediaStream;return e.captureStream().getVideoTracks().forEach((function(e){r.addTrack(e)})),new u(r,t)},u.createWithAudioAsync=function(e,t,r){void 0===t&&(t={display:!0}),void 0===r&&(r={});var o=u.create(e,r);return o.addAudioAsync(t).then((function(){return o}))},e=a,t=c,u}();//# sourceMappingURL=CanvasRecorder.min.js.map
